generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  clerkId              String             @unique
  email                String             @unique
  name                 String?
  subscriptionTier     SubscriptionTier
  subscriptionStatus   SubscriptionStatus
  polarSubscriptionId  String?
  polarCustomerId      String?
  analysesCount        Int                @default(0)
  monthlyAnalysesUsed  Int                @default(0)
  lastResetDate        DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  analyses             Analysis[]
  apiKeys              ApiKey[]
  usageLogs            UsageLog[]
  webhookEndpoints     WebhookEndpoint[]

  @@index([email])
  @@index([clerkId])
}

model Analysis {
  id               String   @id @default(cuid())
  userId           String
  title            String
  content          String
  wordCount        Int
  readabilityScore Float?
  seoScore         Float?
  keywordDensity   Json?
  suggestions      Json?
  tokensUsed       Int      @default(0)
  processingTimeMs Int?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model ApiKey {
  id                 String      @id @default(cuid())
  userId             String
  name               String
  keyPrefix          String      @unique
  hashedKey          String      @unique
  lastFourChars      String
  environment        Environment
  tier               ApiKeyTier
  rateLimit          Int
  dailyLimit         Int
  monthlyLimit       Int
  totalRequests      Int         @default(0)
  successfulRequests Int         @default(0)
  failedRequests     Int         @default(0)
  dailyUsage         Int         @default(0)
  monthlyUsage       Int         @default(0)
  lastUsedAt         DateTime?
  lastResetDate      DateTime?
  ipWhitelist        String[]
  isActive           Boolean     @default(true)
  revokedAt          DateTime?
  revokedReason      String?
  expiresAt          DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageLogs          UsageLog[]

  @@index([userId])
  @@index([hashedKey])
  @@index([keyPrefix])
  @@index([isActive])
}

model UsageLog {
  id               String   @id @default(cuid())
  apiKeyId         String?
  userId           String?
  endpoint         String
  method           String
  statusCode       Int
  tokensUsed       Int?
  processingTimeMs Int?
  wordCount        Int?
  ipAddress        String
  userAgent        String?
  requestId        String   @unique
  errorMessage     String?
  errorCode        String?
  timestamp        DateTime @default(now())
  apiKey           ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, timestamp])
  @@index([userId, timestamp])
  @@index([timestamp])
}

model WebhookEndpoint {
  id            String            @id @default(cuid())
  userId        String
  url           String
  description   String?
  secret        String
  events        String[]
  isActive      Boolean           @default(true)
  lastSuccessAt DateTime?
  lastFailureAt DateTime?
  failureCount  Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deliveries    WebhookDelivery[]
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WebhookDelivery {
  id                String          @id @default(cuid())
  webhookEndpointId String
  eventType         String
  payload           Json
  statusCode        Int?
  responseBody      String?
  responseTimeMs    Int?
  attemptNumber     Int
  success           Boolean
  errorMessage      String?
  createdAt         DateTime        @default(now())
  deliveredAt       DateTime?
  webhookEndpoint   WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId, createdAt])
}

model RateLimit {
  id           String   @id @default(cuid())
  identifier   String
  endpoint     String
  requestCount Int
  windowStart  DateTime
  updatedAt    DateTime @updatedAt

  @@unique([identifier, endpoint])
  @@index([identifier])
}

enum SubscriptionTier {
  FREE
  PRO
  BUSINESS
  API_STARTER
  API_GROWTH
  API_ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

enum Environment {
  PRODUCTION
  TESTING
}

enum ApiKeyTier {
  STARTER
  GROWTH
  ENTERPRISE
}
